<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MLP Predictions Demo (Excel)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --bg:#0b0c10; --card:#121318; --muted:#a7acb5; --fg:#e6e9ef; --accent:#6ea8fe; }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--fg);}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px;}
    .card{background:var(--card);border-radius:16px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.25);}
    h1{font-size:24px;margin:0 0 12px}
    .sub{color:var(--muted);font-size:14px;margin-bottom:16px}
    .row{display:grid;grid-template-columns:1fr;gap:16px}
    @media (min-width: 900px){ .row{grid-template-columns:1.1fr .9fr;} }
    .controls{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin:8px 0 4px}
    select,button{background:#1d1f27;color:var(--fg);border:1px solid #2a2d36;border-radius:10px;padding:10px 12px}
    button{cursor:pointer}
    .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:10px}
    .k{background:#151721;border:1px solid #232635;border-radius:14px;padding:12px}
    .k div{font-size:12px;color:var(--muted)}
    .k b{font-size:18px}
    canvas{background:#0e0f14;border-radius:12px;padding:8px}
    .footer{color:#8a90a0;font-size:12px;margin-top:12px}
    a{color:var(--accent);text-decoration:none}
    .legend{font-size:12px;color:var(--muted);margin:8px 0}
    .chartwrap{position:relative;height:320px}
    @media (min-width: 900px){ .chartwrap{height:360px} }
    .row > div{min-height:0}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Predictions vs Actuals — Live from Excel</h1>
      <p class="sub">No Java changes needed. This page reads your <code>.xlsx</code> from <code>/demo/data</code>, computes MAE/MSE/RMSE/R² in the browser, and draws the charts.</p>

      <div class="controls">
        <label for="fileSel">Dataset:</label>
        <select id="fileSel">
          <option value="Analysis_forGOLD.xlsx">Analysis_forGOLD.xlsx</option>
          <option value="Analysis_for2.xlsx">Analysis_for2.xlsx</option>
        </select>

        <label for="downSel">Max points:</label>
        <select id="downSel">
          <option value="1000">1,000</option>
          <option value="2000" selected>2,000</option>
          <option value="4000">4,000</option>
          <option value="0">All</option>
        </select>

        <button id="reloadBtn">Reload</button>
      </div>

      <div class="kpis">
        <div class="k"><div>MAE</div><b id="mae">—</b></div>
        <div class="k"><div>MSE</div><b id="mse">—</b></div>
        <div class="k"><div>RMSE</div><b id="rmse">—</b></div>
        <div class="k"><div>R²</div><b id="r2">—</b></div>
      </div>

      <div class="row" style="margin-top:14px">
        <div>
          <div class="legend">Line chart — Y True vs Y Pred (auto-downsampled for speed)</div>
          <div class="chartwrap"><canvas id="lineChart"></canvas></div>
        </div>
        <div>
          <div class="legend">Scatter — Y True vs Y Pred (y = x line shown)</div>
          <div class="chartwrap"><canvas id="scatterChart"></canvas></div>
        </div>
      </div>
      <div class="footer">Tip: Keep the Excel files in <code>/demo/data</code>. On Vercel, set Framework: <b>Other</b>, Root: <code>/demo</code>, Output: <code>.</code>. This page expects columns named <code>Y True</code> and <code>Y Pred</code> in the first sheet.</div>
    </div>
  </div>

  <!-- SheetJS for reading .xlsx -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script>
    const els = {
      mae: document.getElementById('mae'),
      mse: document.getElementById('mse'),
      rmse: document.getElementById('rmse'),
      r2: document.getElementById('r2'),
      fileSel: document.getElementById('fileSel'),
      downSel: document.getElementById('downSel'),
      reloadBtn: document.getElementById('reloadBtn'),
      line: document.getElementById('lineChart'),
      scatter: document.getElementById('scatterChart'),
    };

    let lineChart, scatterChart;

    function downsample(arr, maxPoints){
      if(!maxPoints || maxPoints<=0 || arr.length <= maxPoints) return arr;
      const step = Math.ceil(arr.length / maxPoints);
      const out = [];
      for(let i=0;i<arr.length;i+=step){ out.push(arr[i]); }
      return out;
    }

    function metrics(yTrue, yPred){
      const n = Math.min(yTrue.length, yPred.length);
      let mae=0, mse=0, mean=0;
      for(let i=0;i<n;i++){ mean += yTrue[i]; }
      mean /= n;
      let ssRes=0, ssTot=0;
      for(let i=0;i<n;i++){
        const e = yTrue[i]-yPred[i];
        mae += Math.abs(e);
        mse += e*e;
        ssRes += e*e;
        const d = yTrue[i]-mean;
        ssTot += d*d;
      }
      mae/=n; mse/=n;
      const rmse = Math.sqrt(mse);
      const r2 = ssTot === 0 ? 1 : 1 - (ssRes/ssTot);
      return {mae, mse, rmse, r2};
    }

    async function fetchXlsx(path){
      const res = await fetch(path);
      if(!res.ok) throw new Error('Failed to fetch '+path);
      const ab = await res.arrayBuffer();
      const wb = XLSX.read(ab, {type:'array'});
      const first = wb.SheetNames[0];
      const data = XLSX.utils.sheet_to_json(wb.Sheets[first], {defval:null});
      return data;
    }

    function toSeries(rows){
      // Expect columns 'Y True' and 'Y Pred'
      const yTrue = [], yPred = [];
      for(const r of rows){
        const yt = r['Y True'];
        const yp = r['Y Pred'];
        if(typeof yt === 'number' && typeof yp === 'number'){
          yTrue.push(yt); yPred.push(yp);
        }
      }
      return {yTrue, yPred};
    }

    function fmt(x){ 
      if(!isFinite(x)) return '—';
      if(Math.abs(x) >= 100) return x.toFixed(1);
      if(Math.abs(x) >= 10) return x.toFixed(2);
      return x.toFixed(4);
    }

    function draw(lineCtx, scatterCtx, yTrue, yPred, maxPoints){
      // Clean previous
      if(lineChart){ lineChart.destroy(); }
      if(scatterChart){ scatterChart.destroy(); }

      const n = Math.min(yTrue.length, yPred.length);
      const x = Array.from({length:n}, (_,i)=>i+1);
      const yT = downsample(yTrue, maxPoints);
      const yP = downsample(yPred, maxPoints);
      const xD = downsample(x, maxPoints);

      lineChart = new Chart(lineCtx, {
        type: 'line',
        data: {
          labels: xD,
          datasets: [
            { label: 'Y True', data: yT, pointRadius: 0, borderWidth: 1.5, tension: 0.1 },
            { label: 'Y Pred', data: yP, pointRadius: 0, borderWidth: 1.5, tension: 0.1 }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          plugins: { legend: { labels: { boxWidth: 10 } } },
          scales: {
            x: { ticks: { maxTicksLimit: 10 } },
            y: { beginAtZero: false }
          }
        }
      });

      // Scatter with y=x
      const pairs = [];
      for(let i=0;i<n;i++){ pairs.push({x: yTrue[i], y: yPred[i]}); }
      const minV = Math.min(...yTrue, ...yPred);
      const maxV = Math.max(...yTrue, ...yPred);
      scatterChart = new Chart(scatterCtx, {
        type: 'scatter',
        data: {
          datasets: [
            { label: 'Pred vs True', data: pairs, pointRadius: 2 },
            { label: 'y = x', type: 'line', data: [{x:minV,y:minV},{x:maxV,y:maxV}], borderWidth: 1, pointRadius: 0 }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { labels: { boxWidth: 10 } } },
          scales: {
            x: { title: { display: true, text: 'Y True' } },
            y: { title: { display: true, text: 'Y Pred' } }
          }
        }
      });
    }

    async function run(){
      const fname = els.fileSel.value;
      const maxPts = parseInt(els.downSel.value, 10);
      const rows = await fetchXlsx('data/'+fname);
      const {yTrue, yPred} = toSeries(rows);
      const m = metrics(yTrue, yPred);
      els.mae.textContent = fmt(m.mae);
      els.mse.textContent = fmt(m.mse);
      els.rmse.textContent = fmt(m.rmse);
      els.r2.textContent = fmt(m.r2);
      draw(els.line, els.scatter, yTrue, yPred, maxPts);
    }

    els.reloadBtn.addEventListener('click', run);
    els.fileSel.addEventListener('change', run);
    els.downSel.addEventListener('change', run);
    run();
  </script>
</body>
</html>
